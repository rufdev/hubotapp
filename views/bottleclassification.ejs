<div class="container-fluid text-center mt-5">
  <h1>ESP32-CAM Stream</h1>
  <div class="row">
    <div class="col-md-12">
      <img
        id="stream"
        style="
          display: block;
          -webkit-user-select: none;
          margin: auto;
          background-color: hsl(0, 0%, 25%);
        "
      />
    </div>
    <div class="col-md-12">
      <div id="prediction" class="col-md-12 d-none">
        <h4>Prediction:</h4>
        <div class="progress">
          <div
            id="prediction-bar-largebottle"
            class="progress-bar"
            role="progressbar"
            style="width: 0%"
            aria-valuenow="0"
            aria-valuemin="0"
            aria-valuemax="100"
          ></div>
          <div
            id="prediction-bar-notbottle"
            class="progress-bar bg-danger"
            role="progressbar"
            style="width: 0%"
            aria-valuenow="0"
            aria-valuemin="0"
            aria-valuemax="100"
          ></div>
          <div
          id="prediction-bar-smallbottle"
          class="progress-bar bg-warning"
          role="progressbar"
          style="width: 0%"
          aria-valuenow="0"
          aria-valuemin="0"
          aria-valuemax="100"
        ></div>
        </div>
        <p id="prediction-text"></p>
      </div>
      <button id="resetBtn" class="btn btn-primary mt-3 d-none">
        Reset Stream
      </button>
      <button id="captureBtn" class="btn btn-primary mt-3">
        Capture Image ESP32
      </button>
    </div>
  </div>
  <div class="row">
    <!-- <div class="col-md-12 mx-auto">
      <video id="videoElement" width="640" height="480" class="mx-auto"></video>
      <br />
      <button id="captureButton">Capture</button>
    </div> -->
  </div>
</div>

<!-- Latest compiled and minified JavaScript -->
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
  crossorigin="anonymous"
></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
  const resetBtn = document.getElementById("resetBtn");
  const captureBtn = document.getElementById("captureBtn");
  const stream = document.getElementById("stream");
  const predictiondisplay = document.getElementById("prediction");
  const progressBarlargebottle = document.getElementById("prediction-bar-largebottle");
  const progressBarnotbottle = document.getElementById("prediction-bar-notbottle");
  const progressBarsmallbottle = document.getElementById("prediction-bar-smallbottle");
  const predictionText = document.getElementById("prediction-text");
  const esp32camip = "<%= esp32camip %>";

  const esp32stream = `http://${esp32camip}:81/stream`;
  stream.src = esp32stream;

  captureBtn.addEventListener("click", async () => {
    try {
      const response = await axios("/predict-bottleclassification");

      stream.src = response.data.url;
      const prediction = response.data.prediction;
      console.log(prediction);
      const predictionlargebottle = prediction[0];
      const predictionnotbottle = prediction[1];
      const predictionsmallbottle = prediction[2];

      stream.onload = () => {
        predictiondisplay.classList.remove("d-none");
        resetBtn.classList.remove("d-none");

        //make progress bar based on prediction and display prediction text
        const predictionValue = Math.max(predictionlargebottle, predictionnotbottle, predictionsmallbottle);

        progressBarlargebottle.style.width = `${predictionlargebottle * 100}%`;
        progressBarnotbottle.style.width = `${predictionnotbottle * 100}%`;
        progressBarsmallbottle.style.width = `${predictionsmallbottle * 100}%`;

        predictionText.textContent = `This image has a ${Math.round(predictionValue * 100)}% chance of being a ${predictionValue === predictionlargebottle ? "large bottle" : predictionValue === predictionnotbottle ? "not a bottle" : "small bottle"}.`;
      };
    } catch (error) {
      console.error(error);
    }
  });

  resetBtn.addEventListener("click", (e) => {
    stream.src = esp32stream;
    predictiondisplay.classList.add("d-none");
    resetBtn.classList.add("d-none");
  });

</script>
